var json_raw = '{"type":3,"lines":[{"time":17110,"words":[{"start":17110,"end":18300,"string":"\u3042\u308c\u304b\u3089"},{"start":18880,"end":20280,"string":"\u307c\u304f\u305f\u3061\u306f"}]},{"time":21090,"words":[{"start":21090,"end":22210,"string":"\u4f55\u304b\u3092"},{"start":22210,"end":23390,"string":"\u4fe1\u3058\u3066"},{"start":23390,"end":25110,"string":"\u3053\u308c\u305f\u304b\u306a\u3041\u2026"}]},{"time":26160,"words":[{"start":26160,"end":27340,"string":"\u591c\u7a7a\u306e"},{"start":27980,"end":29420,"string":"\u3080\u3053\u3046\u306b\u306f"}]},{"time":30100,"words":[{"start":30100,"end":31870,"string":"\u660e\u65e5\u304c\u3082\u3046"},{"start":32460,"end":33860,"string":"\u5f85\u3063\u3066\u3044\u308b"}]},{"time":35630,"words":[{"start":35630,"end":54210,"string":"\uff1c\u266a\uff1e"}]},{"time":54210,"words":[{"start":54210,"end":55390,"string":"\u8ab0\u304b\u306e"},{"start":55670,"end":56530,"string":"\u58f0\u306b"},{"start":56860,"end":57670,"string":"\u6c17\u3065\u304d"}]},{"time":57920,"words":[{"start":57920,"end":59080,"string":"\u307c\u304f\u3089\u306f"},{"start":59160,"end":59630,"string":"\u8eab\u3092"},{"start":59630,"end":61070,"string":"\u3072\u305d\u3081\u305f"}]},{"time":62890,"words":[{"start":62890,"end":64480,"string":"\u516c\u5712\u306e"},{"start":64750,"end":65610,"string":"\u30d5\u30a7\u30f3\u30b9"},{"start":65900,"end":66690,"string":"\u8d8a\u3057\u306b"}]},{"time":66840,"words":[{"start":66840,"end":69200,"string":"\u591c\u306e\u98a8\u304c"},{"start":69200,"end":70060,"string":"\u5439\u3044\u305f"}]},{"time":71170,"words":[{"start":71170,"end":73250,"string":"\u541b\u304c\u4f55\u304b"},{"start":73250,"end":75230,"string":"\u4f1d\u3048\u3088\u3046\u3068"}]},{"time":76020,"words":[{"start":76020,"end":76910,"string":"\u306b\u304e\u308a"},{"start":77170,"end":78140,"string":"\u8fd4\u3057\u305f"},{"start":78280,"end":79770,"string":"\u305d\u306e\u624b\u306f"}]},{"time":80480,"words":[{"start":80480,"end":81400,"string":"\u307c\u304f\u306e"},{"start":81400,"end":82550,"string":"\u5fc3\u306e"},{"start":82800,"end":83910,"string":"\u3084\u3089\u304b\u3044"},{"start":83910,"end":84830,"string":"\u5834\u6240\u3092"}]},{"time":84970,"words":[{"start":84970,"end":86250,"string":"\u4eca\u3067\u3082"},{"start":86250,"end":86720,"string":"\u307e\u3060"},{"start":86720,"end":88280,"string":"\u3057\u3081\u3064\u3051\u308b"}]},{"time":91770,"words":[{"start":91770,"end":93060,"string":"\u3042\u308c\u304b\u3089"},{"start":93670,"end":95060,"string":"\u307c\u304f\u305f\u3061\u306f"}]},{"time":95810,"words":[{"start":95810,"end":96900,"string":"\u4f55\u304b\u3092"},{"start":96900,"end":100040,"string":"\u4fe1\u3058\u3066\u3053\u308c\u305f\u304b\u306a\u3041\u2026"}]},{"time":100840,"words":[{"start":100840,"end":101770,"string":"\u30de\u30c9\u3092"},{"start":101770,"end":102590,"string":"\u305d\u3063\u3068"},{"start":102590,"end":104030,"string":"\u958b\u3051\u3066\u307f\u308b"}]},{"time":104860,"words":[{"start":104860,"end":106810,"string":"\u51ac\u306e\u98a8\u306e"},{"start":106810,"end":108570,"string":"\u306b\u304a\u3044\u304c\u3057\u305f"}]},{"time":109880,"words":[{"start":109880,"end":111150,"string":"\u60b2\u3057\u307f"},{"start":111500,"end":111940,"string":"\u3063\u3066"},{"start":111940,"end":113140,"string":"\u3044\u3064\u304b\u306f"}]},{"time":113900,"words":[{"start":113900,"end":114750,"string":"\u6d88\u3048\u3066"},{"start":114750,"end":115850,"string":"\u3057\u307e\u3046"},{"start":115850,"end":116500,"string":"\u3082\u306e"},{"start":116500,"end":118110,"string":"\u306a\u306e\u304b\u306a\u3041\u2026"}]},{"time":118960,"words":[{"start":118960,"end":120740,"string":"\u30bf\u30e1\u606f\u306f"},{"start":120740,"end":122120,"string":"\u5c11\u3057\u3060\u3051"}]},{"time":122930,"words":[{"start":122930,"end":123790,"string":"\u767d\u304f"},{"start":123790,"end":125250,"string":"\u6b8b\u3063\u3066"},{"start":125250,"end":125820,"string":"\u3059\u3050"},{"start":125820,"end":126630,"string":"\u6d88\u3048\u305f"}]},{"time":127190,"words":[{"start":127190,"end":146750,"string":"\uff1c\u266a\uff1e"}]},{"time":146750,"words":[{"start":146750,"end":148190,"string":"\u6b69\u304d\u51fa\u3059"},{"start":148530,"end":149370,"string":"\u3053\u3068"},{"start":149630,"end":150520,"string":"\u3055\u3048\u3082"}]},{"time":150690,"words":[{"start":150690,"end":151990,"string":"\u3044\u3061\u3044\u3061"},{"start":151990,"end":152970,"string":"\u305f\u3081\u3089\u3046"},{"start":152970,"end":153840,"string":"\u304f\u305b\u306b"}]},{"time":156080,"words":[{"start":156080,"end":157440,"string":"\u3064\u307e\u3089\u306a\u3044"},{"start":157440,"end":159470,"string":"\u5e38\u8b58\u306a\u3069"}]},{"time":159660,"words":[{"start":159660,"end":161180,"string":"\u3064\u3076\u305b\u308b"},{"start":161580,"end":163050,"string":"\u3068\u601d\u3063\u3066\u305f"}]},{"time":163910,"words":[{"start":163910,"end":164900,"string":"\u541b\u306b"},{"start":164900,"end":166350,"string":"\u8a71\u3057\u305f"},{"start":166580,"end":167990,"string":"\u8a00\u8449\u306f"}]},{"time":168760,"words":[{"start":168760,"end":170290,"string":"\u3069\u308c\u3060\u3051"},{"start":170290,"end":171370,"string":"\u6b8b\u3063\u3066"},{"start":171370,"end":172520,"string":"\u3044\u308b\u306e?"}]},{"time":173280,"words":[{"start":173280,"end":174190,"string":"\u307c\u304f\u306e"},{"start":174190,"end":175370,"string":"\u5fc3\u306e"},{"start":175670,"end":177610,"string":"\u3044\u3061\u3070\u3093\u5965\u3067"}]},{"time":177770,"words":[{"start":177770,"end":179290,"string":"\u304b\u3089\u56de\u308a"},{"start":179290,"end":181010,"string":"\u3057\u3064\u3065\u3051\u308b"}]},{"time":184590,"words":[{"start":184590,"end":185270,"string":"\u3042\u306e"},{"start":185270,"end":186690,"string":"\u3053\u308d\u306e"},{"start":186690,"end":187880,"string":"\u672a\u6765\u306b"}]},{"time":188560,"words":[{"start":188560,"end":189740,"string":"\u307c\u304f\u3089\u306f"},{"start":189740,"end":190900,"string":"\u7acb\u3063\u3066"},{"start":190900,"end":192710,"string":"\u3044\u308b\u306e\u304b\u306a\u3041\u2026"}]},{"time":193690,"words":[{"start":193690,"end":194860,"string":"\u5168\u3066\u304c"},{"start":195480,"end":196250,"string":"\u601d\u3046"},{"start":196250,"end":196910,"string":"\u307b\u3069"}]},{"time":197620,"words":[{"start":197620,"end":198870,"string":"\u3046\u307e\u304f\u306f"},{"start":198870,"end":200240,"string":"\u3044\u304b\u306a\u3044"},{"start":200240,"end":201400,"string":"\u307f\u305f\u3044\u3060"}]},{"time":202700,"words":[{"start":202700,"end":203990,"string":"\u3053\u306e\u307e\u307e"},{"start":204560,"end":205960,"string":"\u3069\u3053\u307e\u3067\u3082"}]},{"time":206670,"words":[{"start":206670,"end":207600,"string":"\u65e5\u3005\u306f"},{"start":207600,"end":209000,"string":"\u7d9a\u3044\u3066"},{"start":209000,"end":210950,"string":"\u3044\u304f\u306e\u304b\u306a\u3041\u2026"}]},{"time":211750,"words":[{"start":211750,"end":213200,"string":"\u96f2\u306e\u306a\u3044"},{"start":213690,"end":215080,"string":"\u661f\u7a7a\u304c"}]},{"time":215750,"words":[{"start":215750,"end":218090,"string":"\u30de\u30c9\u306e\u3080\u3053\u3046\u306b"},{"start":218090,"end":219430,"string":"\u3064\u3065\u3044\u3066\u308b"}]},{"time":220830,"words":[{"start":220830,"end":222060,"string":"\u3042\u308c\u304b\u3089"},{"start":222600,"end":224050,"string":"\u307c\u304f\u305f\u3061\u306f"}]},{"time":224840,"words":[{"start":224840,"end":226000,"string":"\u4f55\u304b\u3092"},{"start":226000,"end":227100,"string":"\u4fe1\u3058\u3066"},{"start":227100,"end":228970,"string":"\u3053\u308c\u305f\u304b\u306a\u3041\u2026"}]},{"time":229860,"words":[{"start":229860,"end":231090,"string":"\u591c\u7a7a\u306e"},{"start":231690,"end":233100,"string":"\u3080\u3053\u3046\u306b\u306f"}]},{"time":233820,"words":[{"start":233820,"end":235450,"string":"\u3082\u3046\u660e\u65e5\u304c"},{"start":236110,"end":237630,"string":"\u5f85\u3063\u3066\u3044\u308b"}]},{"time":239850,"words":[{"start":239850,"end":257950,"string":"\uff1c\u266a\uff1e"}]},{"time":257950,"words":[{"start":257950,"end":258950,"string":""}]}]}';


$(function(){
	$('#play-view').hide();
	$('#search-view form').submit(function(e){
		var title = $('#search-view form input:first').val();
		$.get('http://localhost:8080/search',
			{'title': title},
			function(data){
				// TODO: adapt respose data
				$('#search-view').hide();
				$('#play-view').show();
			}
		);
		e.preventDefault();
	});

	console.log(player);
	var response = jQuery.parseJSON(json_raw);
	console.log(response);

	var lines
	var lnum=0
	$('#lyric').append($('<div id="wrap"></div>'));
	for  (var lindex in response.lines){
		var lelement = response.lines[lindex];
		lines = $("<div class='line' id='line"+lnum+"' data-linetime='"+lelement.time+"'></div>")
		for  (var windex in lelement.words){
			var welement = lelement.words[windex]
			var w = $("<span class='word' id='w"+welement.start+"' data-time='"+welement.start+"'>"+welement.string+"</span> ");
			lines.append(w)
		}
		$('#wrap').append(lines);
		lnum++;
	}

	lnum=0
	for  (var lindex in response.lines){
		var lelement = response.lines[lindex];
		lines = $("<div class='line' id='lineO"+lnum+"'></div>")
		for  (var windex in lelement.words){
			var welement = lelement.words[windex]
			var w = $("<span class='wordO' id='wO"+welement.start+"'>"+welement.string+"</span>&nbsp;&nbsp;");
			lines.append(w)
		}
		$('#original').append(lines);
		lnum++;
	}

	lnum=0;
	for  (var lindex in response.lines){
		var lelement = response.lines[lindex];
		lines = $("<div class='line' id='lineE"+lnum+"'></div>")
		for  (var windex in lelement.words){
			var welement = lelement.words[windex]
			var w = $("<input type='text' id='wE"+welement.start+"' value='"+welement.string+"' />");
			lines.append(w)
		}
		$('#editor').append(lines);
		lnum++;
	}

	setInterval(function(e){ watchdog()},200)
});

function watchdog(){
	var ct = player.getCurrentTime()*1000 + 4500
	elms = $('.word').removeClass('done');
	for(var i=0;i<elms.length;i++){
		var elm = $(elms[i]);
		if(!elm.hasClass('done')  && elm.data('time')< ct){
			elm.addClass('done')
		}
	}
	lines = $('.line');
	for(var i=0;i<lines.length;i++){
		var line = $(lines[i]);
		if(line.data('linetime') > ct){
			$('#lyric #wrap').css('top', -28 * i+ 'px');
			break;
		}
	}
}
